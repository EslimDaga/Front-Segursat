{% extends "base.html" %}
{% load static %}
{% block head_content %}
  <title>Mapa - Segursat GPS</title>
  <!-- Begin Page Level Custom Styles -->
  <link href="{% static 'plugins/widgets-map/css/style.css' %}" rel="stylesheet">
  <!-- End Global Mandatory Styles -->
  <script src="{% static 'plugins/leaflet/js/leaflet.js' %}"></script>
  <link rel="stylesheet" href="{% static 'plugins/leaflet/css/leaflet.css' %}">
  <script src="https://kit.fontawesome.com/2ea5efd210.js" crossorigin="anonymous"></script>
  <link href="{% static 'assets/css/components/tabs-accordian/custom-tabs.css' %}" rel="stylesheet">
  <link href="{% static 'plugins/widgets-map/css/marker.css' %}" rel="stylesheet">
  <link href="{% static 'assets/css/elements/search.css' %}" rel="stylesheet">
  <link href="{% static 'assets/css/scrollspyNav.css' %}" rel="stylesheet">
  <link href="{% static 'assets/css/components/custom-modal.css' %}" rel="stylesheet">
  <link href="{% static 'plugins/animate/animate.css' %}" rel="stylesheet">
  <style>
    .map {
      width: 100%;
      height: 100%
    }

    .list-group-item:hover{
      background-color: #1b55e2;
      color: white;
    }
  </style>
  <!-- End Page Level Custom Styles -->
{% endblock %}
{% block container %}
<div id="content" class="main-content container-map-all" >
  <div class="widget-constent-area">
    <div class="map" id="map"></div>
    <!-- Begin Sidebar -->
    {% include "maps/map-sidebar.html" %}
    <!-- End Sidebar -->
    <!-- Begin Right Bar -->
    {% include "maps/map-controls.html" %}
    <!-- End Right Bar -->
    <!-- Begin Bottom Bar -->
    {% include "maps/map-bottom-bar.html" %}
    <!-- End Bottom Bar -->
  </div>
</div>
{% endblock %}
{% block script_content %}
  <script src="{% static 'plugins/widgets-map/js/core.js' %}"></script>
  <script src="{% static 'plugins/widgets-map/js/app.js' %}"></script>
  <script src="{% static 'assets/js/scrollspyNav.js' %}"></script>
  <script src="{% static 'plugins/blockui/jquery.blockUI.min.js' %}"></script>
  <script src="{% static 'plugins/blockui/custom-blockui.js' %}"></script>
  <!-- <script src="{% static 'assets/js/elements/custom-search.js' %}"></script> -->
  <script src="{% static 'plugins/leaflet-rotated-marker/js/leaflet.rotatedMarker.js' %}"></script>
  <script>
    $('#input-search').on('keyup', function() {
      var rex = new RegExp($(this).val(), 'i');
      $('.searchable-container .items').hide();
      $('.searchable-container .items').filter(function() {
        return rex.test($(this).text());
      }).show();
    });
  </script>
  <script>
    map = L.map('map',{
      center: [-12.105049,-77.027134],
      zoom: 16,
    });
    const openStreetMap = L.tileLayer(
      'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      {
        attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a>',
        maxZoom: 19,
      }
    );
    const googleStreetsMap = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
      attribution: '&copy; <a href="https://maps.google.com/">Google Maps</a>',
      maxZoom: 20,
      subdomains:['mt0','mt1','mt2','mt3']
    });
    const googleHybridMap = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{
      attribution: '&copy; <a href="https://maps.google.com/">Google Maps</a>',
      maxZoom: 20,
      subdomains:['mt0','mt1','mt2','mt3']
    });
    const baseLayers = {
      'Open Street Maps': openStreetMap,
      'Google Street Maps': googleStreetsMap,
      'Google Hybrid Maps': googleHybridMap
    };
    let overlays = {};
    L.control.layers(baseLayers,overlays).addTo(map);
    baseLayers['Google Street Maps'].addTo(map);

    const icon = L.divIcon({
      iconSize:null,
      html:`
      <div class="map-label">
        <div class="map-label-title">
          DEMO001
        </div>
        <div class="map-label-content">
          <img id="DEMO001CustomMarker" src="/static/assets/img/markers/vehicle.png" width="26" height="48"/>
        </div>
      </div>
      `
    });
    marker = new L.marker(
      [-12.105049, -77.027134],
      {
        icon: icon,
        title: "DEMO001",
        rotationAngle: 1,
      }
    )
    .addTo(map);
  </script>
  <script>
    //let units;
    const getUnits = async () => {
      const url = `/web/api/units/get-units/`
      const response = await fetch(url);
      const units = await response.json();
      return units;
    }
    const getUnit = async (name) => {
      const url = `/web/api/units/get-unit/${name}/`;
      const response = await fetch(url);
      const unit = await response.json();
      return unit;
    }
    const renderUnitsInSidebar = async() => {
      units = await getUnits();
      let unitList = "";
      for (let i = 0; i < units.length; i++) {
        const unit =
        `
          <div onclick="unitSelect('${units[i].name}')" class="items">
            <div class="user-name">
              <p class="">${units[i].name}</p>
            </div>
            <div class="user-status">
              <span class="badge badge-primary">
                <div class="details">
                  <span data-device="speed">${units[i].device.last_speed} kph</span>
                  <span data-device="detect_engine" class="on"><i class="icon detect_engine"></i></span>
                  <span data-device="status" style="background-color: green" title="Online">online</span>
                </div>
              </span>
            </div>
          </div>
        `;
        unitList += unit;
      }
      document.getElementById("unit-list").innerHTML = unitList;
    }
    /*
    const unitSearch = (name) => {
      let result = -1;
      for (let i=0; i < units.length; i++) {
        if (units[i].name == name) {
          result = i;
          break;
        }
      }
      return result;
    }
    */
    const unitSelect = async (unitName) => {
      const unit = await getUnit(unitName);
      document.getElementById("unitNameSelect").innerHTML = unitName;
      map.panTo([unit.device.last_latitude,unit.device.last_longitude]);
      marker.setLatLng([unit.device.last_latitude,unit.device.last_longitude])
    }
















    renderUnitsInSidebar();

  </script>
{% endblock%}