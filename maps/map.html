{% extends "base.html" %}
{% load static %}
{% block head_content %}
  <title>Mapa - Segursat GPS</title>
  <!-- Begin Page Level Custom Styles -->
  <link href="{% static 'plugins/widgets-map/css/style.css' %}" rel="stylesheet">
  <!-- End Global Mandatory Styles -->
  <!-- <script src="{% static 'plugins/leaflet/js/leaflet.js' %}"></script> -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <!-- <link rel="stylesheet" href="{% static 'plugins/leaflet/css/leaflet.css' %}"> -->
  <script src="https://kit.fontawesome.com/2ea5efd210.js" crossorigin="anonymous"></script>
  <link href="{% static 'assets/css/components/tabs-accordian/custom-tabs.css' %}" rel="stylesheet">
  <link href="{% static 'plugins/widgets-map/css/marker.css' %}" rel="stylesheet">
  Â¸
  <link href="{% static 'assets/css/elements/search.css' %}" rel="stylesheet">
  <link href="{% static 'assets/css/scrollspyNav.css' %}" rel="stylesheet">
  <link href="{% static 'assets/css/components/custom-modal.css' %}" rel="stylesheet">
  <link href="{% static 'plugins/animate/animate.css' %}" rel="stylesheet">
  <link href="{% static 'assets/css/elements/tooltip.css' %}" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
  <link href="{% static 'plugins/sweetalerts/sweetalert2.min.css' %}" rel="stylesheet" type="text/css" />
  <link href="{% static 'plugins/sweetalerts/sweetalert.css' %}" rel="stylesheet" type="text/css" />
  <link href="{% static 'assets/css/components/custom-sweetalert.css' %}" rel="stylesheet" type="text/css" />
  <style>
    .map {
      width: 100%;
      height: 100%
    }

    .list-group-item:hover{
      background-color: #F8951D;
      color: white;
    }
  </style>
  <style>
    .blockui-growl-message {
        display: none;
        text-align: left;
        padding: 15px;
        background-color: #455a64;
        color: #fff;
        border-radius: 3px;
    }
    .blockui-animation-container { display: none; }
    .multiMessageBlockUi {
        display: none;
        background-color: #455a64;
        color: #fff;
        border-radius: 3px;
        padding: 15px 15px 10px 15px;
    }
    .multiMessageBlockUi i { display: block }
</style>

  <!-- End Page Level Custom Styles -->
{% endblock %}
{% block container %}
<div id="content" class="main-content container-map-all" >
  <div class="widget-constent-area">
    <div class="map" id="map"></div>
    <!-- Begin Sidebar -->
    {% include "maps/map-sidebar.html" %}
    <!-- End Sidebar -->
    <!-- Begin Right Bar -->
    {% include "maps/map-controls.html" %}
    <!-- End Right Bar -->
    <!-- Begin Bottom Bar -->
    {% include "maps/map-bottom-bar.html" %}
    <!-- End Bottom Bar -->
  </div>
</div>
{% endblock %}
{% block script_content %}
  <script src="{% static 'plugins/widgets-map/js/core.js' %}"></script>
  <script src="{% static 'plugins/widgets-map/js/app.js' %}"></script>
  <script src="{% static 'assets/js/elements/tooltip.js' %}"></script>
  <script src="{% static 'assets/js/scrollspyNav.js' %}"></script>
  <script src="{% static 'plugins/blockui/jquery.blockUI.min.js' %}"></script>
  <script src="{% static 'plugins/blockui/custom-blockui.js' %}"></script>
  <!-- <script src="{% static 'assets/js/elements/custom-search.js' %}"></script> -->
  <script src="{% static 'plugins/leaflet-rotated-marker/js/leaflet.rotatedMarker.js' %}"></script>
  <script src="https://unpkg.com/leaflet-ant-path" type="text/javascript"></script>
  
  <script src="{% static 'assets/js/maps/MapView.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
  <script src="{% static 'plugins/sweetalerts/sweetalert2.min.js' %}"></script>
  <script src="{% static 'plugins/sweetalerts/custom-sweetalert.js' %}"></script>
  <script src="{% static 'plugins/blockui/jquery.blockUI.min.js' %}"></script>
  <script src="{% static 'plugins/blockui/custom-blockui.js' %}"></script>
  <script>
    $('#input-search').on('keyup', function() {
      var rex = new RegExp($(this).val(), 'i');
      $('.searchable-container .items').hide();
      $('.searchable-container .items').filter(function() {
        return rex.test($(this).text());
      }).show();
    });
  </script>
  <script>
    const mapView = new MapView();
    mapView.run();

    let ws;
    const getWSURI = () => {
      let domain = window.location.hostname;
      let port = 8000;
      if (location.port == ""){
        port = 80;
      }
      wsURI = `ws://${domain}:${port}/ws/locations/{{user.profile.account}}/`;
      return wsURI;
    }
    // websocket
    const connect = () => {
      wsURI = getWSURI();
      ws = new WebSocket(wsURI);
      ws.onopen = function() {
        console.log('Socket is connected!');
      };
      ws.onmessage = function(e) {
        newLocation = JSON.parse(e.data).message;
        console.log(newLocation);
        mapView.updateMarkerPosition(
          newLocation['unit_name'],
          [
            newLocation['latitude'],
            newLocation['longitude']
          ],
          newLocation['angle']
        );
      };
      ws.onclose = function(e) {
        console.log('Socket is closed. Reconnect will be attempted in 5 second.', e.reason);
        setTimeout(function() {
          exampleModal();
        }, 5000);
      };
      ws.onerror = function(err) {
        console.error('Socket encountered error: ', err.message, 'Closing socket');
        ws.close();
      };
    }
    connect();
  </script>
  <script>
    /* $('select').selectpicker("refresh"); */
    $('#block-content').on('click', function() {
    var block = $('.map');
    $(block).block({
        message: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-loader spin"><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg>',
        timeout: 2000, //unblock after 2 seconds
        overlayCSS: {
            backgroundColor: 'white',
            opacity: 0.8,
            cursor: 'wait'
        },
        css: {
            border: 0,
            color: '#1b55e2',
            padding: 0,
            backgroundColor: 'transparent'
        }
    });
});
  </script>
  <script>
    document.getElementById("history-btn").addEventListener("click", function() {
      const historyDateFrom = document.getElementById("history-date-from").value;
      const historyDateTo = document.getElementById("history-date-to").value;
      const historyUnit =  document.getElementById("history-units").value;
      const historyMarkerCheckbox = document.getElementById("history-marker-checkbox").checked;
      const historyPlaybackCheckbox = document.getElementById("history-playback-checkbox").checked;
      const historySpeedRange = parseInt(document.getElementById("history-speed-range").value);
      if (historyDateFrom === "") {
        swal({
          type: 'error',
          title: 'Oops...',
          text: 'Seleccione una fecha inicial valida',
          padding: '2em'
        })
      }else if (historyDateTo === "") {
        swal({
          type: 'error',
          title: 'Oops...',
          text: 'Seleccione una fecha final valida',
          padding: '2em'
        })
      }else if (historyUnit === "") {
        swal({
          type: 'error',
          title: 'Oops...',
          text: 'Seleccione una unidad',
          padding: '2em'
        })
      }else{
        mapView.drawLocationHistory(
          historyUnit,
          historyDateFrom,
          historyDateTo,
          historyMarkerCheckbox,
          historyPlaybackCheckbox,
          historySpeedRange
        );
      }

    });
  </script>
{% endblock%}