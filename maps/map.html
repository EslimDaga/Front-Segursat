{% extends "base.html" %}
{% load static %}
{% block head_content %}
  <title>Mapa - Segursat GPS</title>
  <!-- Begin Page Level Custom Styles -->
  <link href="{% static 'plugins/widgets-map/css/style.css' %}" rel="stylesheet">
  <!-- End Global Mandatory Styles -->
  <script src="{% static 'plugins/leaflet/js/leaflet.js' %}"></script>
  <link rel="stylesheet" href="{% static 'plugins/leaflet/css/leaflet.css' %}">
  <script src="https://kit.fontawesome.com/2ea5efd210.js" crossorigin="anonymous"></script>
  <link href="{% static 'assets/css/components/tabs-accordian/custom-tabs.css' %}" rel="stylesheet">
  <link href="{% static 'plugins/widgets-map/css/marker.css' %}" rel="stylesheet">
  Â¸
  <link href="{% static 'assets/css/elements/search.css' %}" rel="stylesheet">
  <link href="{% static 'assets/css/scrollspyNav.css' %}" rel="stylesheet">
  <link href="{% static 'assets/css/components/custom-modal.css' %}" rel="stylesheet">
  <link href="{% static 'plugins/animate/animate.css' %}" rel="stylesheet">
  <link href="{% static 'assets/css/elements/tooltip.css' %}" rel="stylesheet" type="text/css" />
  <style>
    .map {
      width: 100%;
      height: 100%
    }

    .list-group-item:hover{
      background-color: #1b55e2;
      color: white;
    }
  </style>
  <!-- End Page Level Custom Styles -->
{% endblock %}
{% block container %}
<div id="content" class="main-content container-map-all" >
  <div class="widget-constent-area">
    <div class="map" id="map"></div>
    <!-- Begin Sidebar -->
    {% include "maps/map-sidebar.html" %}
    <!-- End Sidebar -->
    <!-- Begin Right Bar -->
    {% include "maps/map-controls.html" %}
    <!-- End Right Bar -->
    <!-- Begin Bottom Bar -->
    {% include "maps/map-bottom-bar.html" %}
    <!-- End Bottom Bar -->
  </div>
</div>
{% endblock %}
{% block script_content %}
  <script src="{% static 'plugins/widgets-map/js/core.js' %}"></script>
  <script src="{% static 'plugins/widgets-map/js/app.js' %}"></script>
  <script src="{% static 'assets/js/elements/tooltip.js' %}"></script>
  <script src="{% static 'assets/js/scrollspyNav.js' %}"></script>
  <script src="{% static 'plugins/blockui/jquery.blockUI.min.js' %}"></script>
  <script src="{% static 'plugins/blockui/custom-blockui.js' %}"></script>
  <!-- <script src="{% static 'assets/js/elements/custom-search.js' %}"></script> -->
  <script src="{% static 'plugins/leaflet-rotated-marker/js/leaflet.rotatedMarker.js' %}"></script>
  <script src="https://unpkg.com/leaflet-ant-path" type="text/javascript"></script>
  <script src="{% static 'assets/js/maps/MapView.js' %}"></script>
  <script>
    $('#input-search').on('keyup', function() {
      var rex = new RegExp($(this).val(), 'i');
      $('.searchable-container .items').hide();
      $('.searchable-container .items').filter(function() {
        return rex.test($(this).text());
      }).show();
    });
  </script>
  <script>
    const mapView = new MapView();
    mapView.run();

    let ws;
    const getWSURI = () => {
      let domain = window.location.hostname;
      let port = 8000;
      if (location.port == ""){
        port = 80;
      }
      wsURI = `ws://${domain}:${port}/ws/locations/{{user.profile.account}}/`;
      return wsURI;
    }
    // websocket
    const connect = () => {
      wsURI = getWSURI();
      ws = new WebSocket(wsURI);
      ws.onopen = function() {
        console.log('Socket is connected!');
      };
      ws.onmessage = function(e) {
        newLocation = JSON.parse(e.data).message;
        mapView.updateMarkerPosition(
          newLocation['unit_name'],
          [
            newLocation['latitude'],
            newLocation['longitude']
          ],
          newLocation['angle']
        );
      };
      ws.onclose = function(e) {
        console.log('Socket is closed. Reconnect will be attempted in 5 second.', e.reason);
        setTimeout(function() {
          exampleModal();
        }, 5000);
      };
      ws.onerror = function(err) {
        console.error('Socket encountered error: ', err.message, 'Closing socket');
        ws.close();
      };
    }
    connect();
  </script>
{% endblock%}